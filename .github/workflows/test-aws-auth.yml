name: Test AWS Authentication

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-aws-auth.yml'

permissions:
  id-token: write
  contents: read

jobs:
  test-aws-authentication:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "==================================="
          echo "AWS Authentication Test"
          echo "==================================="
          echo ""
          aws sts get-caller-identity
          echo ""
          echo "✅ AWS authentication successful!"
          echo ""
          echo "Account ID: ${{ secrets.AWS_ACCOUNT_ID }}"
          echo "Region: ${{ secrets.AWS_REGION }}"

      - name: Test ECR access
        run: |
          echo "==================================="
          echo "Testing ECR Access"
          echo "==================================="
          echo ""
          aws ecr describe-repositories || echo "No repositories found (expected for new account)"
          echo ""
          echo "✅ ECR access verified!"

      - name: Test ECS access
        run: |
          echo "==================================="
          echo "Testing ECS Access"
          echo "==================================="
          echo ""
          aws ecs list-clusters || echo "No clusters found (expected for new account)"
          echo ""
          echo "✅ ECS access verified!"

      - name: Test CloudWatch Logs access
        run: |
          echo "==================================="
          echo "Testing CloudWatch Logs Access"
          echo "==================================="
          echo ""
          aws logs describe-log-groups --limit 1 || echo "No log groups found (expected for new account)"
          echo ""
          echo "✅ CloudWatch Logs access verified!"

      - name: Summary
        run: |
          echo ""
          echo "==================================="
          echo "✅ All AWS access tests passed!"
          echo "==================================="
          echo ""
          echo "Verified permissions:"
          echo "  ✓ STS (AWS identity)"
          echo "  ✓ ECR (Elastic Container Registry)"
          echo "  ✓ ECS (Elastic Container Service)"
          echo "  ✓ CloudWatch Logs"
          echo ""
          echo "GitHub Actions is ready to deploy to AWS!"
